{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Create an EC2 instance running the latest AWS GigaVUE-FM AMI with IAM role",
    "Parameters": {
        "KeyPair": {
            "Description": "Name of an existing EC2 Key Pair to enable SSH access to the GigaVUE-FM instances",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
        },
        "VolumeSize": {
            "Description": "The size(GB) of the EBS volume to attach to the GigaVUE-FM instances, EBS MaxVolume Size 16TB",
            "Type": "Number"
        },
        "InstanceType": {
            "Description": "GigaVUE-FM EC2 instance type",
            "Type": "String"
        },
        "VPC": {
            "Description": "VPC to launch virtual server in",
            "Type": "AWS::EC2::VPC::Id"
        },
        "Subnet": {
            "Description": "subnet to launch virtual server in",
            "Type": "AWS::EC2::Subnet::Id"
        }
    },
    "Mappings": {
        "RegionMap": {
            "us-gov-west-1": {
                "ImageID": "ami-c1fb6ca0"
            },
            "us-east-1": {
                "ImageID": "ami-fde15f82"
            },
            "us-west-1": {
                "ImageID": "ami-bb9488db"
            },
            "us-east-2": {
                "ImageID": "ami-fdd1e398"
            },
            "us-west-2": {
                "ImageID": "ami-4f6b1e37"
            },
            "sa-east-1": {
                "ImageID": "ami-9c491bf0"
            },
            "eu-central-1": {
                "ImageID": "ami-6589a88e"
            },
            "ca-central-1": {
                "ImageID": "ami-343fbe50"
            },
            "eu-west-1": {
                "ImageID": "ami-04331a7d"
            },
            "eu-west-2": {
                "ImageID": "ami-71826016"
            },
            "ap-southeast-1": {
                "ImageID": "ami-62654d1e"
            },
            "ap-southeast-2": {
                "ImageID": "ami-e46db886"
            },
            "ap-northeast-1": {
                "ImageID": "ami-d6df3da9"
            },
            "ap-northeast-2": {
                "ImageID": "ami-49802927"
            },
            "ap-south-1": {
                "ImageID": "ami-a64868c9"
            }
        }
    },
    "Resources": {
        "GigaVUEFMRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/"
            }
        },
        "GigaVUEFMPolicies": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-instance-policy"
                        ]
                    ]
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "ec2:Describe*",
                                "ec2:RebootInstances",
                                "ec2:RunInstances",
                                "ec2:StartInstances",
                                "ec2:StopInstances",
                                "ec2:TerminateInstances",
                                "ec2:ReportInstanceStatus",
                                "ec2:Disassociate*",
                                "ec2:CreateTags",
                                "ec2:AttachVolume",
                                "ec2:AttachNetworkInterface",
                                "ec2:Associate*",
                                "ec2:Allocate*",
                                "ec2:DeleteTags",
                                "ec2:DeleteVolume",
                                "ec2:DeleteNetworkInterface",
                                "ec2:ModifyInstanceAttribute",
                                "ec2:ModifyNetworkInterfaceAttribute",
                                "ec2:ModifyVolumeAttribute",
                                "ec2:ReleaseAddress",
                                "elasticloadbalancing:Describe*",
                                "autoscaling:Describe*",
                                "cloudwatch:*",
                                "logs:*",
                                "sns:*",
                                "sqs:*",
                                "events:*"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:CreateBucket",
                                "s3:DeleteBucket",
                                "s3:DeleteObject",
                                "s3:DeleteObjectVersion",
                                "s3:Get*",
                                "s3:ListAllMyBuckets",
                                "s3:PutBucketNotification",
                                "s3:PutBucketTagging",
                                "s3:PutBucketVersioning",
                                "s3:PutObject",
                                "s3:PutObjectTagging",
                                "s3:ReplicateDelete",
                                "s3:ReplicateObject",
                                "s3:RestoreObject"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "iam:PassRole"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "GigaVUEFMRole"
                    }
                ]
            }
        },
        "GigaVUEFMProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "GigaVUEFMRole"
                    }
                ]
            }
        },
        "GigaVUEFMSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "SG for GigaVUE-FM EC2 Instance",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "9900",
                        "ToPort": "9903",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": "4789",
                        "ToPort": "4789",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "47",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Gigamon_SG"
                    }
                ]
            }
        },
        "GigaVUEFMInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "KeyName": {
                    "Ref": "KeyPair"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "ImageID"
                    ]
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "IamInstanceProfile": {
                    "Ref": "GigaVUEFMProfile"
                },
                "NetworkInterfaces": [
                    {
                        "AssociatePublicIpAddress": "True",
                        "DeleteOnTermination": "True",
                        "SubnetId": {
                            "Ref": "Subnet"
                        },
                        "DeviceIndex": "0",
                        "GroupSet": [
                            {
                                "Ref": "GigaVUEFMSG"
                            }
                        ]
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sdb",
                        "Ebs": {
                            "VolumeType": "gp2",
                            "DeleteOnTermination": "true",
                            "VolumeSize": {
                                "Ref": "VolumeSize"
                            }
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "GigaVUE-FM"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "PublicDnsName": {
            "Description": "Server's PublicIp Address",
            "Value": {
                "Fn::GetAtt": [
                    "GigaVUEFMInstance",
                    "PublicDnsName"
                ]
            }
        },
        "InstanceId": {
            "Description": "The Instance ID",
            "Value": {
                "Ref": "GigaVUEFMInstance"
            }
        },
        "SGId": {
            "Description": "The SG ID",
            "Value": {
                "Ref": "GigaVUEFMSG"
            }
        }
    }
}